<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/B Testing Dashboard - Email Marketing</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #4a4a4a;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #777;
            font-size: 1.1em;
        }

        .tab-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }

        .tab-button {
            flex-grow: 1;
            padding: 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
            background: none;
            border: none;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab-button.active {
            background: #f8f8f8;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="file"]:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #667eea;
            outline: none;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            background: #5a6fe0;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #764ba2;
            margin-left: 10px;
        }
        .btn-secondary:hover {
            background: #6a3e90;
        }

        .btn-red {
            background: #e74c3c;
        }
        .btn-red:hover {
            background: #c0392b;
        }

        .campaign-list, .campaign-detail {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .campaign-list ul {
            list-style: none;
            padding: 0;
        }

        .campaign-list li {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .campaign-list li:last-child {
            border-bottom: none;
        }

        .campaign-list li span {
            font-weight: bold;
            color: #4a4a4a;
        }

        .campaign-list li .actions {
            display: flex;
            gap: 10px;
        }

        .campaign-list li .actions button {
            padding: 8px 15px;
            font-size: 0.9em;
            border-radius: 5px;
        }

        .campaign-detail h3 {
            color: #4a4a4a;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .campaign-detail p {
            margin-bottom: 10px;
            color: #555;
        }

        .campaign-detail .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .campaign-detail .stat-box {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .campaign-detail .stat-box h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .campaign-detail .stat-box p {
            font-size: 2em;
            font-weight: bold;
            color: #4a4a4a;
        }

        .variation-results {
            margin-top: 30px;
        }

        .variation-results h4 {
            color: #4a4a4a;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .variation-card {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .variation-card h5 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .variation-card ul {
            list-style: none;
            padding: 0;
        }

        .variation-card li {
            margin-bottom: 8px;
            color: #555;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-top: 30px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .alert.show {
            opacity: 1;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5em;
        }

        .loading .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>A/B Testing Email Marketing</h1>
            <p>Create, send, and analyze your email campaigns with AI-generated variations.</p>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('create-campaign-tab')">Create New Campaign</button>
                <button class="tab-button" onclick="showTab('manage-campaigns-tab')">Manage Campaigns</button>
            </div>

            <div id="create-campaign-tab" class="tab-content active">
                <form id="create-campaign-form">
                    <h2>New Campaign Details</h2>
                    <div class="form-group">
                        <label for="company_name">Your Company Name:</label>
                        <input type="text" id="company_name" name="company_name" required>
                    </div>
                    <div class="form-group">
                        <label for="product_name">Product/Service Name:</label>
                        <input type="text" id="product_name" name="product_name" required>
                    </div>
                    <div class="form-group">
                        <label for="offer_details">Campaign Offer Details (e.g., "50% off for first 3 months"):</label>
                        <textarea id="offer_details" name="offer_details" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="campaign_type">Campaign Type:</label>
                        <select id="campaign_type" name="campaign_type" required>
                            <option value="">Select Type</option>
                            <option value="promotional">Promotional</option>
                            <option value="newsletter">Newsletter</option>
                            <option value="product_launch">Product Launch</option>
                            <option value="re_engagement">Re-Engagement</option>
                            <option value="abandoned_cart">Abandoned Cart</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="target_audience">Target Audience (Optional, e.g., "small business owners"):</label>
                        <input type="text" id="target_audience" name="target_audience">
                    </div>
                    <button type="submit" class="btn">Generate Email Variations</button>
                </form>
            </div>

            <div id="manage-campaigns-tab" class="tab-content">
                <h2>Your Campaigns</h2>
                <div class="campaign-list" id="campaign-list-container">
                    <p>Loading campaigns...</p>
                </div>
                <div id="campaign-detail-view" class="campaign-detail" style="display:none;">
                    <button class="btn btn-secondary" onclick="hideCampaignDetail()">← Back to Campaigns</button>
                    <h3 id="campaign-detail-name" style="margin-top: 20px;"></h3>
                    <p>Status: <span id="campaign-detail-status"></span></p>
                    <p>Total Recipients: <span id="campaign-detail-total-recipients"></span></p>

                    <div class="stats-grid" id="overall-stats-grid">
                        </div>

                    <div class="variation-results" id="variation-results-container">
                        <h4>Variation Performance</h4>
                        </div>

                    <div class="chart-container">
                        <canvas id="campaignMetricsChart"></canvas>
                    </div>

                    <h4 style="margin-top: 30px;">Upload Recipients</h4>
                    <form id="upload-recipients-form">
                        <input type="hidden" id="current_campaign_id" name="campaign_id">
                        <div class="form-group">
                            <label for="recipient_csv">Upload CSV (Email, First Name, Last Name):</label>
                            <input type="file" id="recipient_csv" name="file" accept=".csv" required>
                        </div>
                        <button type="submit" class="btn">Upload & Assign Recipients</button>
                    </form>

                    <h4 style="margin-top: 30px;">Send Campaign</h4>
                    <p>Once recipients are uploaded, you can send the campaign emails.</p>
                    <button class="btn btn-red" id="send-campaign-btn" onclick="sendCampaign()">Send Campaign Emails</button>
                    <div id="send-campaign-status" style="margin-top: 10px; font-weight: bold;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = "{{ base_url }}"; // Flask template variable

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');

            if (tabId === 'manage-campaigns-tab') {
                loadCampaigns();
            }
        }

        document.getElementById('create-campaign-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading("Generating AI email variations...");

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${BASE_URL}/create-campaign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showAlert('Campaign created and variations generated successfully!', 'success');
                    this.reset();
                    loadCampaigns(); // Refresh campaign list
                    showTab('manage-campaigns-tab'); // Switch to manage tab
                    showCampaignDetail(result.campaign_id); // Show new campaign's details
                } else {
                    showAlert(`Error creating campaign: ${result.error}`, 'danger');
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showAlert('An unexpected error occurred. Please try again.', 'danger');
            }
        });

        async function loadCampaigns() {
            showLoading("Loading campaigns...");
            try {
                const response = await fetch(`${BASE_URL}/campaigns`);
                const result = await response.json();
                hideLoading();

                const listContainer = document.getElementById('campaign-list-container');
                listContainer.innerHTML = ''; // Clear previous list

                if (result.success && result.campaigns.length > 0) {
                    const ul = document.createElement('ul');
                    result.campaigns.forEach(campaign => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${campaign.name} (${campaign.status.toUpperCase()}) - ${new Date(campaign.created_at).toLocaleDateString()}</span>
                            <div class="actions">
                                <button class="btn" onclick="showCampaignDetail('${campaign.id}')">View Results</button>
                            </div>
                        `;
                        ul.appendChild(li);
                    });
                    listContainer.appendChild(ul);
                } else {
                    listContainer.innerHTML = '<p>No campaigns found. Create one to get started!</p>';
                }
            } catch (error) {
                hideLoading();
                console.error('Error loading campaigns:', error);
                showAlert('Failed to load campaigns. Please try again.', 'danger');
            }
        }

        let myChart; // To store the Chart.js instance

        async function showCampaignDetail(campaignId) {
            showLoading("Loading campaign results...");
            try {
                const response = await fetch(`${BASE_URL}/campaign-results/${campaignId}`);
                const result = await response.json();
                hideLoading();

                if (result.success) {
                    const campaign = result.campaign;
                    const metrics = result.metrics;

                    document.getElementById('campaign-detail-name').textContent = `Campaign: ${campaign.name}`;
                    document.getElementById('campaign-detail-status').textContent = campaign.status.toUpperCase();
                    document.getElementById('campaign-detail-total-recipients').textContent = campaign.total_recipients;
                    document.getElementById('current_campaign_id').value = campaignId;

                    // Hide send button if campaign already sent
                    const sendBtn = document.getElementById('send-campaign-btn');
                    if (campaign.status === 'sent') {
                        sendBtn.style.display = 'none';
                        document.getElementById('send-campaign-status').textContent = 'This campaign has been sent.';
                    } else {
                        sendBtn.style.display = 'inline-block';
                        document.getElementById('send-campaign-status').textContent = '';
                    }

                    renderCampaignResults(metrics, campaign.total_recipients);
                    renderChart(metrics);

                    document.getElementById('campaign-list-container').style.display = 'none';
                    document.getElementById('campaign-detail-view').style.display = 'block';
                } else {
                    showAlert(`Error loading campaign details: ${result.error}`, 'danger');
                }
            } catch (error) {
                hideLoading();
                console.error('Error loading campaign detail:', error);
                showAlert('Failed to load campaign details. Please try again.', 'danger');
            }
        }

        function hideCampaignDetail() {
            document.getElementById('campaign-detail-view').style.display = 'none';
            document.getElementById('campaign-list-container').style.display = 'block';
            loadCampaigns(); // Reload list to ensure status updates
        }

        function renderCampaignResults(metrics, totalRecipients) {
            const variationResultsContainer = document.getElementById('variation-results-container');
            variationResultsContainer.innerHTML = '<h4>Variation Performance</h4>'; // Clear previous results

            const overallStatsGrid = document.getElementById('overall-stats-grid');
            overallStatsGrid.innerHTML = ''; // Clear previous overall stats

            let overallOpened = 0;
            let overallClicked = 0;
            let overallConverted = 0;
            let overallReopened = 0; // New: Overall Reopened
            let overallSent = 0;

            for (const variationName in metrics) {
                const metric = metrics[variationName];
                overallOpened += metric.opened;
                overallClicked += metric.clicked;
                overallConverted += metric.converted;
                overallReopened += (metric.reopen_rate / 100) * metric.opened; // Approximate number from rate
                overallSent += metric.total_sent;

                const variationCard = document.createElement('div');
                variationCard.classList.add('variation-card');
                variationCard.innerHTML = `
                    <h5>${variationName}</h5>
                    <ul>
                        <li>Sent: <strong>${metric.total_sent}</strong></li>
                        <li>Opened: <strong>${metric.opened}</strong> (${metric.open_rate.toFixed(2)}%)</li>
                        <li>Clicked: <strong>${metric.clicked}</strong> (${metric.click_rate.toFixed(2)}% of sent)</li>
                        <li>Re-Opened: <strong>${((metric.reopen_rate / 100) * metric.opened).toFixed(0)}</strong> (${metric.reopen_rate.toFixed(2)}% of opened)</li>
                        <li>Conversions: <strong>${metric.converted}</strong> (${metric.conversion_rate.toFixed(2)}%)</li>
                        <li>Click-to-Open Rate (CTOR): <strong>${metric.click_through_rate.toFixed(2)}%</strong></li>
                    </ul>
                `;
                variationResultsContainer.appendChild(variationCard);
            }

            // Render overall stats
            const overallOpenRate = (overallOpened / overallSent * 100) || 0;
            const overallClickRate = (overallClicked / overallSent * 100) || 0;
            const overallConversionRate = (overallConverted / overallSent * 100) || 0;
            const overallClickToOpenRate = (overallClicked / overallOpened * 100) || 0;
            const overallReopenRate = (overallReopened / overallOpened * 100) || 0; // New: Overall Reopen Rate

            overallStatsGrid.innerHTML = `
                <div class="stat-box">
                    <h4>Emails Sent</h4>
                    <p>${overallSent}</p>
                </div>
                <div class="stat-box">
                    <h4>Total Opened</h4>
                    <p>${overallOpened}</p>
                </div>
                <div class="stat-box">
                    <h4>Total Clicks</h4>
                    <p>${overallClicked}</p>
                </div>
                <div class="stat-box">
                    <h4>Total Conversions</h4>
                    <p>${overallConverted}</p>
                </div>
                <div class="stat-box">
                    <h4>Overall Open Rate</h4>
                    <p>${overallOpenRate.toFixed(2)}%</p>
                </div>
                <div class="stat-box">
                    <h4>Overall Click Rate (CTR)</h4>
                    <p>${overallClickRate.toFixed(2)}%</p>
                </div>
                <div class="stat-box">
                    <h4>Overall Re-Open Rate</h4>
                    <p>${overallReopenRate.toFixed(2)}%</p>
                </div>
                <div class="stat-box">
                    <h4>Overall Conversion Rate</h4>
                    <p>${overallConversionRate.toFixed(2)}%</p>
                </div>
                <div class="stat-box">
                    <h4>Overall Click-to-Open Rate (CTOR)</h4>
                    <p>${overallClickToOpenRate.toFixed(2)}%</p>
                </div>
            `;
        }

        function renderChart(metrics) {
            const ctx = document.getElementById('campaignMetricsChart').getContext('2d');

            if (myChart) {
                myChart.destroy(); // Destroy previous chart instance
            }

            const labels = Object.keys(metrics);
            const openRates = labels.map(label => metrics[label].open_rate.toFixed(2));
            const clickRates = labels.map(label => metrics[label].click_rate.toFixed(2));
            const conversionRates = labels.map(label => metrics[label].conversion_rate.toFixed(2));
            const reopenRates = labels.map(label => metrics[label].reopen_rate.toFixed(2)); // New: Re-Open Rates

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Open Rate (%)',
                            data: openRates,
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Click Rate (CTR) (%)',
                            data: clickRates,
                            backgroundColor: 'rgba(118, 75, 162, 0.7)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Re-Open Rate (%)', // New: Dataset for Re-Open Rate
                            data: reopenRates,
                            backgroundColor: 'rgba(255, 159, 64, 0.7)', // A new color
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Conversion Rate (%)',
                            data: conversionRates,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentage (%)'
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('upload-recipients-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading("Uploading recipients...");

            const campaignId = document.getElementById('current_campaign_id').value;
            const fileInput = document.getElementById('recipient_csv');
            const formData = new FormData();
            formData.append('campaign_id', campaignId);
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${BASE_URL}/upload-recipients`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showAlert(result.message, 'success');
                    // Reload campaign detail to show updated total recipients
                    showCampaignDetail(campaignId);
                    fileInput.value = ''; // Clear file input
                } else {
                    showAlert(`Error uploading recipients: ${result.error}`, 'danger');
                }
            } catch (error) {
                hideLoading();
                console.error('Error uploading recipients:', error);
                showAlert('An unexpected error occurred during upload. Please try again.', 'danger');
            }
        });

        async function sendCampaign() {
            if (!confirm('Are you sure you want to send this campaign? This action cannot be undone.')) {
                return;
            }

            showLoading("Sending campaign emails. This may take a while...");

            const campaignId = document.getElementById('current_campaign_id').value;
            document.getElementById('send-campaign-btn').disabled = true; // Disable button to prevent double-clicks

            try {
                const response = await fetch(`${BASE_URL}/send-campaign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ campaign_id: campaignId })
                });
                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showAlert(`Campaign sent to ${result.sent_count} recipients!`, 'success');
                    if (result.errors && result.errors.length > 0) {
                        showAlert(`Some emails failed to send: ${result.errors.join('; ')}`, 'danger');
                    }
                    // Reload campaign detail to update status
                    showCampaignDetail(campaignId);
                } else {
                    showAlert(`Error sending campaign: ${result.error}`, 'danger');
                }
            } catch (error) {
                hideLoading();
                console.error('Error sending campaign:', error);
                showAlert('An unexpected error occurred during sending. Please try again.', 'danger');
            } finally {
                document.getElementById('send-campaign-btn').disabled = false;
            }
        }

        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;

            document.querySelector('.container').insertBefore(alert, document.querySelector('.tab-container'));

            setTimeout(() => {
                alert.classList.add('show');
            }, 10); // Small delay to trigger transition

            setTimeout(() => {
                alert.classList.remove('show');
                alert.addEventListener('transitionend', () => alert.remove(), {once: true});
            }, 5000);
        }

        function showLoading(message) {
            const loading = document.createElement('div');
            loading.id = 'loading-overlay';
            loading.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
            loading.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;

            document.body.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('loading-overlay');
            if (loading) {
                loading.remove();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCampaigns();
        });
    </script>
</body>
</html>
